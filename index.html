<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grapple Thief: Master Heist</title>
    <style>
        body { margin: 0; background: #0d1117; color: #c9d1d9; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        canvas { background: #161b22; border: 2px solid #30363d; display: block; cursor: crosshair; box-shadow: 0 0 30px rgba(0,0,0,0.5); max-width: 95vw; max-height: 80vh; }
        .ui { position: absolute; top: 20px; left: 20px; pointer-events: none; background: rgba(13, 17, 23, 0.9); padding: 15px; border-radius: 8px; border: 1px solid #30363d; min-width: 150px; }
        #timer { color: #f85149; font-size: 1.5em; font-weight: bold; font-family: monospace; }
        #score { color: #f1c40f; }
        .hint { position: absolute; bottom: 20px; color: #8b949e; font-size: 14px; text-align: center; }
        .overlay { position: absolute; background: rgba(0,0,0,0.8); width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        button { padding: 15px 30px; font-size: 20px; background: #238636; color: white; border: none; border-radius: 6px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="game-over" class="overlay" style="display:none;">
        <h1 id="msg">MISSION FAILED</h1>
        <button onclick="restartLevel()">RETRY LEVEL</button>
    </div>

    <div class="ui">
        <div id="level-name" style="color:#58a6ff; font-weight:bold;">VAULT 01</div>
        <div id="timer">00:30</div>
        <div id="score">Gems: 0/0</div>
    </div>

    <canvas id="gameCanvas"></canvas>
    <div class="hint">Collect all gems to unlock the next Vault.<br>Watch out for <span style="color:#f85149">RED SPIKES</span>.</div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800; canvas.height = 500;

        const gravity = 0.45;    
        const friction = 0.99;   
        const swingForce = 1.3;  

        let currentLevelIndex = 0;
        let timeLeft = 30;
        let timerInterval;
        let isPlaying = false;
        let ghostTrail = [];
        let particles = [];

        let player = { x: 50, y: 450, vx: 0, vy: 0, radius: 10, color: '#58a6ff' };
        let hook = { active: false, x: 0, y: 0, length: 0 };

        const levels = [
            {
                name: "VAULT 01: THE ENTRY",
                time: 30,
                platforms: [{x: 0, y: 0, w: 800, h: 40}, {x: 300, y: 300, w: 200, h: 20}],
                spikes: [{x: 350, y: 480, w: 100, h: 20}],
                gems: [{x: 400, y: 270, collected: false}]
            },
            {
                name: "VAULT 02: THE SHAFT",
                time: 25,
                platforms: [{x: 0, y: 0, w: 800, h: 40}, {x: 100, y: 200, w: 100, h: 20}, {x: 600, y: 200, w: 100, h: 20}],
                spikes: [{x: 0, y: 480, w: 800, h: 20}, {x: 350, y: 40, w: 100, h: 100}],
                gems: [{x: 150, y: 170, collected: false}, {x: 650, y: 170, collected: false}]
            },
            {
                name: "VAULT 03: PHANTOM GRID",
                time: 40,
                platforms: [{x: 0, y: 0, w: 800, h: 40}, {x: 400, y: 250, w: 20, h: 20}],
                spikes: [{x: 200, y: 40, w: 20, h: 300}, {x: 600, y: 150, w: 20, h: 350}, {x: 0, y: 480, w: 800, h: 20}],
                gems: [{x: 100, y: 100, collected: false}, {x: 700, y: 100, collected: false}, {x: 410, y: 220, collected: false}]
            }
        ];

        function initLevel() {
            const lvl = levels[currentLevelIndex];
            player.x = 50; player.y = 450; player.vx = 0; player.vy = 0;
            timeLeft = lvl.time;
            lvl.gems.forEach(g => g.collected = false);
            document.getElementById('level-name').innerText = lvl.name;
            document.getElementById('game-over').style.display = 'none';
            isPlaying = true;
            
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if(isPlaying) {
                    timeLeft--;
                    document.getElementById('timer').innerText = `00:${timeLeft < 10 ? '0' + timeLeft : timeLeft}`;
                    if(timeLeft <= 0) gameOver("TIME EXPIRED");
                }
            }, 1000);
        }

        function gameOver(msg) {
            isPlaying = false;
            document.getElementById('msg').innerText = msg;
            document.getElementById('game-over').style.display = 'flex';
            clearInterval(timerInterval);
        }

        function restartLevel() { initLevel(); }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.vx = (Math.random() - 0.5) * 8;
                this.vy = (Math.random() - 0.5) * 8;
                this.life = 25; this.color = color;
            }
            update() { this.x += this.vx; this.y += this.vy; this.life--; }
            draw() { ctx.globalAlpha = this.life / 25; ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, 3, 3); }
        }

        window.addEventListener('mousedown', (e) => {
            if(!isPlaying) return;
            const rect = canvas.getBoundingClientRect();
            hook.x = (e.clientX - rect.left) * (canvas.width / rect.width);
            hook.y = (e.clientY - rect.top) * (canvas.height / rect.height);
            hook.length = Math.hypot(hook.x - player.x, hook.y - player.y) * 0.85;
            hook.active = true;
        });

        window.addEventListener('mouseup', () => hook.active = false);

        function update() {
            if(!isPlaying) return;
            const lvl = levels[currentLevelIndex];

            if (hook.active) {
                const dx = player.x - hook.x;
                const dy = player.y - hook.y;
                const distance = Math.hypot(dx, dy);
                if (distance > hook.length) {
                    const angle = Math.atan2(dy, dx);
                    player.x = hook.x + Math.cos(angle) * hook.length;
                    player.y = hook.y + Math.sin(angle) * hook.length;
                    player.vx -= Math.cos(angle) * swingForce;
                    player.vy -= Math.sin(angle) * swingForce;
                }
            }

            player.vy += gravity; player.vx *= friction; player.vy *= friction;
            player.x += player.vx; player.y += player.vy;

            // Wall/Floor Limits
            if (player.y > canvas.height - 10) { player.y = canvas.height - 10; player.vy *= -0.5; }
            if (player.x < 10 || player.x > canvas.width - 10) { player.vx *= -0.7; }

            // Ghost Trail
            const speed = Math.hypot(player.vx, player.vy);
            if (speed > 8) ghostTrail.push({ x: player.x, y: player.y, alpha: 0.6 });
            ghostTrail.forEach(g => g.alpha -= 0.04);
            ghostTrail = ghostTrail.filter(g => g.alpha > 0);

            // SPIKE COLLISION
            lvl.spikes.forEach(s => {
                if(player.x > s.x && player.x < s.x + s.w && player.y > s.y && player.y < s.y + s.h) {
                    initLevel(); // Reset on spike hit
                }
            });

            // GEM COLLISION
            let collectedCount = 0;
            lvl.gems.forEach(gem => {
                if (!gem.collected && Math.hypot(player.x - gem.x, player.y - gem.y) < 25) {
                    gem.collected = true;
                    for(let i=0; i<15; i++) particles.push(new Particle(gem.x, gem.y, '#f1c40f'));
                }
                if(gem.collected) collectedCount++;
            });

            document.getElementById('score').innerText = `Gems: ${collectedCount}/${lvl.gems.length}`;

            // NEXT LEVEL CHECK
            if(collectedCount === lvl.gems.length) {
                currentLevelIndex++;
                if(currentLevelIndex >= levels.length) {
                    gameOver("MISSION COMPLETE: MASTER THIEF");
                } else {
                    initLevel();
                }
            }

            particles.forEach((p, i) => { p.update(); if(p.life <= 0) particles.splice(i, 1); });
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const lvl = levels[currentLevelIndex];

            // Draw Trail
            ghostTrail.forEach(g => {
                ctx.beginPath(); ctx.arc(g.x, g.y, player.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(88, 166, 255, ${g.alpha * 0.3})`; ctx.fill();
            });

            // Draw Platforms
            ctx.fillStyle = "#30363d";
            lvl.platforms.forEach(p => ctx.fillRect(p.x, p.y, p.w, p.h));

            // Draw Spikes
            ctx.fillStyle = "#f85149";
            lvl.spikes.forEach(s => {
                ctx.beginPath();
                ctx.moveTo(s.x, s.y + s.h);
                ctx.lineTo(s.x + s.w/2, s.y);
                ctx.lineTo(s.x + s.w, s.y + s.h);
                ctx.fill();
            });

            // Draw Gems
            lvl.gems.forEach(gem => {
                if (!gem.collected) {
                    ctx.fillStyle = "#f1c40f"; ctx.shadowBlur = 10; ctx.shadowColor = "#f1c40f";
                    ctx.beginPath(); ctx.arc(gem.x, gem.y, 8, 0, Math.PI * 2); ctx.fill();
                    ctx.shadowBlur = 0;
                }
            });

            // Draw Rope
            if (hook.active) {
                ctx.beginPath(); ctx.moveTo(player.x, player.y); ctx.lineTo(hook.x, hook.y);
                ctx.strokeStyle = '#58a6ff'; ctx.lineWidth = 2; ctx.stroke();
            }

            // Draw Player
            ctx.fillStyle = player.color; ctx.shadowBlur = 15; ctx.shadowColor = player.color;
            ctx.beginPath(); ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2); ctx.fill();
            ctx.shadowBlur = 0;

            particles.forEach(p => p.draw());
        }

        function loop() { update(); draw(); requestAnimationFrame(loop); }
        initLevel();
        loop();
    </script>
</body>
</html>
